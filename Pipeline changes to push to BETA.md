
**Purpose**: Document CI/CD pipeline changes involved to transition from a test only ecosystem, to a test, beta, and prod

**Changes**: There are several parts to updating your application's pipeline to point to the two Beta environments (and eventually prod). Elements/Systems involved are:

- CircleCI
- HAL9000
- Application's configuration




* * *


<ac:structured-macro ac:name="panel" ac:schema-version="1" ac:macro-id="beebda38-c48c-41b2-8b06-f92163e65373"><ac:parameter ac:name="borderColor">black</ac:parameter><ac:parameter ac:name="titleBGColor">#FFAB00</ac:parameter><ac:parameter ac:name="borderStyle">solid</ac:parameter><ac:parameter ac:name="title">CircleCI</ac:parameter><ac:rich-text-body><p class="auto-cursor-target">There are a couple of different methods of thought for pushing images to both regions:</p><ol><li>Have two separate jobs building their own individual image and push it to their respective region</li><li>Build one image, save it as tar artifact, and pass it to two different jobs, which push to their respective region</li><li>Build one image, tag it, push it to one region, and then re-tag it to push it to the other region<br><br></li></ol><p>For simplicity and efficiency, 1 or 2 seems the most practical. From what was already written, 1 is the far simpler option as it requires no logic to archive the docker image, which increases the amount of time required by circleci.</p><p>Below is a link to an example config file that demonstrates how one could accomplish this, but utilizing YAML anchors to share repeated code to multiple jobs:</p><ac:structured-macro ac:name="panel" ac:schema-version="1" ac:macro-id="6190bbad-73d6-4432-a423-0d06db2beb2c"><ac:parameter ac:name="title">config.yml</ac:parameter><ac:rich-text-body><p><a href="https://git.rockfin.com/LiftOff/liftofflib-cicd/blob/master/examples/config.yml">https://git.rockfin.com/LiftOff/liftofflib-cicd/blob/master/examples/config.yml</a></p></ac:rich-text-body></ac:structured-macro><h4 class="auto-cursor-target"><strong>Some things to note:</strong></h4><ul><li>If you would like to utilize the <a href="https://git.rockfin.com/LiftOff/liftofflib-cicd/blob/9d10c7f66406cf1462bbc1c7a857091c1facaba9/examples/config.yml#L139">nonprod-aws-liftoff-deploy-token</a> as a circleci context for the HAL_TOKEN, it is currently tied to my dash account (<ac:link><ri:user ri:userkey="8a890360638838d6016422d377590058"></ri:user></ac:link> (eparizot-)). I would have to be given deployment access to your app in HAL. This is not mandatory, so no pressure to use it. You'll just have to have it (HAL_TOKEN) defined for your app in the circleci environment variables.</li></ul><ul><li>What you can use freely is the <a href="https://git.rockfin.com/LiftOff/liftofflib-cicd/blob/9d10c7f66406cf1462bbc1c7a857091c1facaba9/examples/config.yml#L160">circleci-ecr-user</a> context. This is encouraged as it contains the necessary credentials to push images to both regions and is already setup to harmoniously work with the example circleci config.</li></ul></ac:rich-text-body></ac:structured-macro>

<ac:structured-macro ac:name="panel" ac:schema-version="1" ac:macro-id="28b2abf0-8f5f-4c62-91c7-9369e9f04190"><ac:parameter ac:name="borderColor">black</ac:parameter><ac:parameter ac:name="titleBGColor">#FF8F73</ac:parameter><ac:parameter ac:name="borderStyle">solid</ac:parameter><ac:parameter ac:name="title">HAL9000</ac:parameter><ac:rich-text-body><p class="auto-cursor-target">For the HAL9000.yml configuration file, you will need to ensure you have a beta-aws environment configured for both regions. A deployment script to register a new task definition was written to abstract that logic from the hal9000 file. If you would like to use it, an example can be found <a href="https://git.rockfin.com/LiftOff/liftofflib-cicd/blob/9d10c7f66406cf1462bbc1c7a857091c1facaba9/examples/.hal9000.yml#L32">here</a>. Please note, if you do use this deployment script, your hal9000.yml must contain all the variables as described in the <a href="https://git.rockfin.com/LiftOff/liftofflib-cicd/blob/master/examples/.hal9000.yml">example</a>.</p><p><br></p><ac:structured-macro ac:name="panel" ac:schema-version="1" ac:macro-id="32bf047e-068e-4d4b-85d6-0519370f0efe"><ac:parameter ac:name="title">hal9000.yml</ac:parameter><ac:rich-text-body><p><a href="https://git.rockfin.com/LiftOff/liftofflib-cicd/blob/master/examples/.hal9000.yml">https://git.rockfin.com/LiftOff/liftofflib-cicd/blob/master/examples/.hal9000.yml</a></p></ac:rich-text-body></ac:structured-macro><p><span>The general gist is that your ECS_CLUSTER must contextually change depending on what value is coming back from HAL. In HAL deployment configurations must have this context filled out with the correct region in the &quot;Context&quot; portion of the deployment definition. Also please make sure your deployment id is filled in your circleci config.yml jobs.</span></p><p class="auto-cursor-target"><ac:image ac:height="250"><ri:attachment ri:filename="image2019-5-1_17-10-10.png"><ri:page ri:space-key="~pvarga" ri:content-title="Pipeline changes to push to BETA"></ri:page></ri:attachment></ac:image></p><p><br></p><p><br></p><p>For usage in Kraken, the experience is pretty much the same as before. You will just need to setup &quot;beta-aws&quot; to point to us-east-2 or us-west-2. For those using Secrets Manager, you probably won't have any involvement with this process.</p><ac:structured-macro ac:name="panel" ac:schema-version="1" ac:macro-id="25a7cb20-9800-4b2a-8b6a-0cada52199c9"><ac:parameter ac:name="borderColor">black</ac:parameter><ac:parameter ac:name="borderStyle">solid</ac:parameter><ac:parameter ac:name="title">Kraken</ac:parameter><ac:rich-text-body><p><ac:image ac:height="250"><ri:attachment ri:filename="image2019-5-1_17-20-2.png"><ri:page ri:space-key="~pvarga" ri:content-title="Pipeline changes to push to BETA"></ri:page></ri:attachment></ac:image></p></ac:rich-text-body></ac:structured-macro><p class="auto-cursor-target"><br></p><ac:structured-macro ac:name="warning" ac:schema-version="1" ac:macro-id="ef9bebdc-5ce1-4fca-9ae3-4a01549d5e77"><ac:rich-text-body><p><span>Kraken at this time of writing does not support multi-region parameter store deployments. This is being worked being added. For the time being only use us-east-2.</span></p></ac:rich-text-body></ac:structured-macro><p class="auto-cursor-target"><br></p></ac:rich-text-body></ac:structured-macro>

<ac:structured-macro ac:name="panel" ac:schema-version="1" ac:macro-id="d9109bd9-f56f-4d99-93eb-fe3731acc0bd"><ac:parameter ac:name="borderColor">black</ac:parameter><ac:parameter ac:name="titleBGColor">#FFC400</ac:parameter><ac:parameter ac:name="borderStyle">solid</ac:parameter><ac:parameter ac:name="title">Application (Code)</ac:parameter><ac:rich-text-body><p class="auto-cursor-target">If you do decide to utilize the <a href="https://git.rockfin.com/LiftOff/liftofflib-cicd/blob/master/deploy.sh">deployment script</a> mentioned above, your task.json file must change to reflect the basic structure it is expecting.</p><ac:structured-macro ac:name="panel" ac:schema-version="1" ac:macro-id="1dd1192b-09a4-4c7d-81ef-f6a494cb79de"><ac:parameter ac:name="title">task.json</ac:parameter><ac:rich-text-body><p><a href="https://git.rockfin.com/LiftOff/liftofflib-cicd/blob/master/examples/task.json">https://git.rockfin.com/LiftOff/liftofflib-cicd/blob/master/examples/task.json</a></p></ac:rich-text-body></ac:structured-macro><p class="auto-cursor-target"><br></p></ac:rich-text-body></ac:structured-macro>







